<!doctype html>
<html>
    <head>
        <title>Cheryl</title>
        <script src="https://unpkg.com/socket.io-client@4.8.1/dist/socket.io.min.js"></script>
        <style>
            html {
                font-family: "Courier New", Courier, monospace;
                background: #f2f2f2;
                display: flex;
                align-items: center;
                justify-content: center;
                height: 100%;
                width: 100%;
            }
            body {
                display: flex;
                flex-direction: column;
                align-items: center;
                max-width: 700px;
                height: 100%;
                width: 100%;
                flex-grow: 1;
                gap: 1rem;
            }
            #messages {
                display: flex;
                flex-direction: column;
                width: 100%;
                height: 100%;
                flex-grow: 1;
                gap: 1rem;
                background: #fff;
                overflow-y: scroll;
                margin-top: 1rem;
                padding: 1rem;
                border-radius: 0.25rem;
            }
            #messageInput {
                width: 100%;
                background: #fff;
                width: 100%;
                outline: none;
                border: none;
                padding: 1rem;
                margin-bottom: 1rem;
                border-radius: 0.25rem;
            }
        </style>
    </head>
    <body>
        <div id="messages"></div>
        <input type="text" id="messageInput" placeholder="Ask Cheryl" />
        <script>
            // Contants
            const ROLE_USER = "user";
            const ROLE_CHRYEL = "system";
            const CONVERSATION_ID_KEY = "conversationID";

            // Variables
            var messages = document.getElementById("messages");
            var messageInput = document.getElementById("messageInput");
            var socket = io({
                query: {
                    user_id: getConversationID(),
                },
            });

            // Functions
            function setConversationID(conversationID) {
                localStorage.setItem(CONVERSATION_ID_KEY, conversationID);
                return conversationID;
            }

            function getConversationID() {
                let conversationID = localStorage.getItem(CONVERSATION_ID_KEY);
                if (conversationID == null) {
                    setConversationID(crypto.randomUUID());
                }
                return conversationID;
            }

            function sendMessage() {
                const conversationID = getConversationID();
                var message = messageInput.value;

                socket.emit("new_message", {
                    data: message,
                    conversation_id: conversationID,
                });

                messages.innerHTML += "<p>You: " + message + "</p>";
                messageInput.value = ""; // Clear the input field
                messages.scrollTop = messages.scrollHeight; // Scroll to the bottom
            }

            function formatReply(message) {
                const sender = (message.role = CHERYL ? "Cheryl" : "You");
                return `<p>${sender}: ${message.message}</p>`;
            }

            // DOM event handlers
            messageInput.addEventListener("keypress", function (event) {
                if (event.key === "Enter") {
                    event.preventDefault();
                    sendMessage();
                }
            });

            // Socket event handlers
            socket.on("connect", function () {
                console.log("Connected to server. Socket ID:", socket.id);
            });
            socket.on("user_connected", function (user) {
                console.log("Connected to server. Socket ID:", user);
            });

            socket.on("user_connected", function (user) {
                console.log();
            });

            socket.on("message", function (message) {
                messages.innerHTML += formatReply(message);
                messages.scrollTop = messages.scrollHeight;
            });

            socket.on("disconnect", function () {
                console.log("Disconnected from server");
            });
        </script>
    </body>
</html>
