<!doctype html>
<html>
    <head>
        <title>Cheryl</title>
        <script src="https://unpkg.com/socket.io-client@4.8.1/dist/socket.io.min.js"></script>
        <style>
            html {
                font-family: "Courier New", Courier, monospace;
                background: #f2f2f2;
                display: flex;
                align-items: center;
                justify-content: center;
                height: 100%;
                width: 100%;
            }
            body {
                display: flex;
                flex-direction: column;
                align-items: center;
                max-width: 700px;
                height: 100%;
                width: 100%;
                flex-grow: 1;
                gap: 1rem;
            }
            #messages {
                display: flex;
                flex-direction: column;
                width: 100%;
                height: 100%;
                flex-grow: 1;
                gap: 1rem;
                background: #fff;
                overflow-y: scroll;
                margin-top: 1rem;
                padding: 1rem;
                border-radius: 0.25rem;
            }
            #messageInput {
                width: 100%;
                background: #fff;
                width: 100%;
                outline: none;
                border: none;
                padding: 1rem;
                margin-bottom: 1rem;
                border-radius: 0.25rem;
            }
        </style>
    </head>
    <body>
        <div id="messages"></div>
        <input type="text" id="messageInput" placeholder="Ask Cheryl" />
        <script>
            // Contants
            const ROLE_USER = "user";
            const ROLE_ASSISTANT = "assistant";
            const CLIENT_ID_KEY = "clientID";
            const KEY_USER_NAME = "userName";

            // State
            const users = {};
            const connectedUsersIDs = {};

            // Must be single qouted
            // prettier-ignore
            const initialMessages = JSON.parse('{{ initial_messages | tojson | safe }}');

            // Must be single qouted
            // prettier-ignore
            const initialConnectedUserIDs = JSON.parse('{{ initial_connected_user_ids | tojson | safe }}')
            for (const id of initialConnectedUserIDs) {
                connectedUsersIDs[id] = true;
            }

            // Must be single qouted
            // prettier-ignore
            const initialUsersOfConversation = JSON.parse('{{ initial_users_of_conversation | tojson | safe }}')
            for (const user of initialUsersOfConversation) {
                users[user.id] = user;
            }

            // Variables
            var messages = document.getElementById("messages");
            var messageInput = document.getElementById("messageInput");
            var socket = io({
                query: {
                    user_id: getClientID(),
                },
            });

            // Functions
            function setClientID(clientID) {
                localStorage.setItem(CLIENT_ID_KEY, clientID);
                return clientID;
            }

            function getClientID() {
                let clientID = localStorage.getItem(CLIENT_ID_KEY);
                if (clientID == null) {
                    setClientID(crypto.randomUUID());
                }
                return clientID;
            }

            function getUserName(userID) {
                console.log("getUserName", { userID, users });
                let user = users[userID];
                if (user == null) {
                    console.log("user not found");
                    return "unknown";
                }
                console.log("user name", { name: user.name });
                return user.name;
            }

            function sendMessage() {
                const clientID = getClientID();
                const body = messageInput.value;

                socket.emit("user_authored_message", {
                    user_id: clientID,
                    body: body,
                });

                messageInput.value = "";
            }

            function createMessageElement(message) {
                console.log("message", message);
                const messageClass =
                    message.role == ROLE_ASSISTANT
                        ? "assistant"
                        : message.user_id == getClientID()
                          ? "current-user"
                          : "other-user";

                // Create the body element
                const bodyEl = document.createElement("p");
                bodyEl.innerHTML += message.message;
                bodyEl.classList.add("body");

                // Create the sender element
                const senderEl = document.createElement("div");
                senderEl.innerHTML += getUserName(message.user_id);
                senderEl.classList.add("sender");

                // Create the message element
                const messageEl = document.createElement("div");
                messageEl.appendChild(senderEl);
                messageEl.appendChild(bodyEl);
                messageEl.classList.add("message", messageClass);

                return messageEl;
            }

            function appendMessages(...msgs) {
                const fragment = new DocumentFragment();
                msgs.forEach((message) => {
                    const element = createMessageElement(message);
                    fragment.appendChild(element);
                });

                messages.appendChild(fragment);
                messages.scrollTop = messages.scrollHeight;
            }

            // DOM event handlers
            messageInput.addEventListener("keypress", function (event) {
                if (event.key === "Enter") {
                    event.preventDefault();
                    sendMessage();
                }
            });

            document.addEventListener("DOMContentLoaded", (event) => {
                appendMessages(...initialMessages);
            });

            // Socket event handlers
            socket.on("connect", function () {
                console.group("Connected to server");
                console.log({
                    socketID: socket.id,
                    userID: getClientID(),
                });
                console.groupEnd();
            });

            socket.on("user_connected", function (user) {
                console.group("User connected");
                console.log(user);

                connectedUsersIDs[user.id] = true;

                console.groupEnd();
            });

            socket.on("user_disconnected", function (user) {
                console.group("User dicconnected");
                console.log(user);

                delete connectedUsers[user.id];

                console.groupEnd();
            });

            socket.on("message_created", function (message) {
                console.group("Message created");
                console.log(message);

                appendMessages(message);

                console.groupEnd();
            });

            socket.on("disconnect", function () {
                console.log("Disconnected from server");
            });
        </script>
    </body>
</html>
